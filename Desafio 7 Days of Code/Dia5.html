<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <title>Desafio #7 Days of Code - Dia 5 / Dia 6 / Explorando Bootstrap</title>
</head>

<body>
    <div class="container">
        <h1 class="text-center"> Lista de Compras </h1>
        <form id="_shop_list_form" class="mt-3">
            <div class="input-group justify-content-center">
                <div class="col-12 col-sm-6">
                    <input id="_shop_item" class="form-control" type="text">
                    <div class="invalid-feedback"><!--Invalid Message-->></div>
                </div>
                <div class="row-cols-auto">
                    <select id="_shop_category" class="form-select" name="shop-category">
                        <option value="Frutas">Frutas</option>
                        <option value="Laticinios">Laticínios</option>
                        <option value="Doces">Doces</option>
                        <option value="Congelados">Congelados</option>
                    </select>
                </div>
                <button class="btn btn-primary align-self-start">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                    </svg>
                </button>
            </div>
        </form>

        <div id="_shop_list_place" class="container">
            <!--Categories List Here -->
        </div>
    </div>
    <style>
        .accordion-body > .list-group > .list-group-item:hover > .btn {
            visibility: visible !important;
        }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        const listaDeCompras = {
            Frutas: ["maçã", "banana", "laranja"],
            Laticinios: ["iogurte", "queijo"],
            Doces: ["paçoca"],
            Congelados: [],
        }

        // Form related
        const $shopListForm = document.getElementById('_shop_list_form');
        const $inputItem = $shopListForm.elements._shop_item;
        $shopListForm.addEventListener('submit', function (event) {
            event.preventDefault();
            let item = $inputItem.value;
            if (item != '') {
                let category = $shopListForm.elements._shop_category.value;
                if (listaDeCompras[category].includes(item)) {
                    inputCustomValidity(false, item, category);
                } else {
                    listaDeCompras[category].push(item);
                    $inputItem.value = '';
                    inputCustomValidity(true);
                    addToRenderedList(item, category);
                }
            }
        });

        // Render List
        const $shopListPlace = document.getElementById('_shop_list_place');
        const $listCategories = document.createElement('div');
        function renderList() {
            $listCategories.classList.add("accordion", "mx-auto", "my-2", "col-md-8");
            for (let category in listaDeCompras) {
                let categorySize = listaDeCompras[category].length;
                let show = (categorySize > 0) ? 'collapse show' : 'collapse';
                $listCategories.insertAdjacentHTML('beforeend', `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#_${category}">
                            ${category}
                            <span id="_badge_${category}" class="badge bg-primary ms-1">${categorySize}</span>
                        </button>
                    </h2>
                    <div id="_${category}" class="accordion-collapse ${show}">
                    <div class="accordion-body">
                        <ul class="list-group">
                            <!--Items here-->
                        </ul>
                    </div>`
                );
            }
            $listCategories.insertAdjacentHTML('beforeend', '</div>');
            $shopListPlace.appendChild($listCategories);
        }

        // Add item to rendered list
        function addToRenderedList(item, category) {
            let $accordionCategory = $listCategories.querySelector(`#_${category} > .accordion-body > .list-group`);
            $accordionCategory.insertAdjacentHTML('beforeend', `
                <li class="list-group-item" data-shop-item="${item}">
                    ${item}
                    <button class="btn invisible" onclick="removeItem('${item}', '${category}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
  <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z"/>
</svg>
                    </button>
                </li>`);
                updateCategoryBadge(category);
        }

        // Update Category Badge 
        function updateCategoryBadge(category) {
            let $badgeCategory = $listCategories.querySelector(`#_badge_${category}`);
            $badgeCategory.innerText = listaDeCompras[category].length;
        }

        // Remove item
        function removeItem(item, category) {
            // Search and remove item from array
            listaDeCompras[category] = listaDeCompras[category].filter(
                function(itemTest){ 
                    if (itemTest != item) 
                        return item;
                }
            );
            // Remove item from rendered list
            let $shopItem = $listCategories.querySelector(`#_${category} > .accordion-body > .list-group > .list-group-item[data-shop-item=${item}]`);
            $shopItem.remove();
            
            updateCategoryBadge(category);
        }

        // Initial rendering
        renderList();
        for (let category in listaDeCompras) {
            for (let item of listaDeCompras[category]) {
                addToRenderedList(item, category);
            }
        }

        // Input custom validity message
        function inputCustomValidity(reset = false, item, category) {
            // $inputItem.setCustomValidity(`${item} já existe na categoria ${category}`);
            // $inputItem.reportValidity();
            if (reset){
                if ($inputItem.classList.contains('is-invalid'))
                    $inputItem.classList.remove('is-invalid');
            } else {
                $inputItem.nextElementSibling.innerText = `${item} já existe na categoria ${category}`;
                if (! $inputItem.classList.contains('is-invalid'))
                    $inputItem.classList.toggle('is-invalid');
            }
        }

    </script>
</body>

</html>